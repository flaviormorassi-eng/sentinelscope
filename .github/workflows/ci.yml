name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: read
  security-events: write

jobs:
  build-and-test:
    name: build-and-test (Node ${{ matrix.node }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [20, 22]
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres" --health-interval=5s --health-timeout=5s --health-retries=10
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/testdb
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-node-${{ matrix.node }}-${{ hashFiles('**/package-lock.json','**/pnpm-lock.yaml','**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Pending migrations gate
        run: |
          OUT=$(npm run db:migrate:pending:json | tail -n 1)
          COUNT=$(echo "$OUT" | node -e "const d=JSON.parse(require('fs').readFileSync(0,'utf8'));process.stdout.write(String(d.pending.length))")
          echo "$OUT"
          if [ "$COUNT" != "0" ]; then echo "Unapplied migrations: $COUNT"; exit 1; fi
      - name: Apply migrations
        run: npm run db:migrate
      - name: Check checksum drift
        run: |
          LABELS='${{ toJson(github.event.pull_request.labels) }}'
          echo "$LABELS" | grep -i allow-migration-checksum-update && echo "Label present, skipping drift failure" && exit 0 || true
          OUT=$(JSON=1 npm run db:migrate:json | tail -n 1)
          WARN=$(echo "$OUT" | node -e "const d=JSON.parse(require('fs').readFileSync(0,'utf8'));process.stdout.write(d.results.filter(r=>r.status==='warn-changed').length)")
          if [ "$WARN" != "0" ]; then echo "Changed applied migrations without label"; echo "$OUT"; exit 1; fi
      - name: Capture migration JSON artifact
        run: |
          OUT=$(JSON=1 npm run db:migrate:json | tail -n 1)
          echo "$OUT" > migration-run.json
      - name: Rollback guard
        run: |
          LABELS='${{ toJson(github.event.pull_request.labels) }}'
          echo "$LABELS" | grep -i allow-rollback && echo "Rollback label present" && exit 0 || true
          CHANGES=$(git diff --name-status origin/main...HEAD | grep '.down.sql' || true)
          if [ -n "$CHANGES" ]; then echo "Down files modified without allow-rollback label"; echo "$CHANGES"; exit 1; fi
      - name: Typecheck
        run: npm run check
      - name: Build
        run: npm run build
      - name: Test
        run: npm run test:junit --silent | tee test-output.txt || exit ${PIPESTATUS[0]}
      - name: Coverage
        run: npm run test:coverage || exit 1
      - name: Coverage gate (lines >= 80%)
        run: |
          SUMMARY_FILE=coverage/coverage-summary.json
          if [ ! -f "$SUMMARY_FILE" ]; then echo "Missing coverage summary: $SUMMARY_FILE"; exit 1; fi
          LINES=$(node -e "const s=require('fs').readFileSync(process.argv[1],'utf8');const j=JSON.parse(s);process.stdout.write(String(j.total.lines.pct))" "$SUMMARY_FILE")
          echo "Line coverage: $LINES%"
          awk 'BEGIN { if ('"$LINES"' < 80) exit 1; }'
      - name: Branch coverage gate (branches >= 70%)
        run: |
          SUMMARY_FILE=coverage/coverage-summary.json
          BRANCHES=$(node -e "const s=require('fs').readFileSync(process.argv[1],'utf8');const j=JSON.parse(s);process.stdout.write(String(j.total.branches.pct))" "$SUMMARY_FILE")
          echo "Branch coverage: $BRANCHES%"
          awk 'BEGIN { if ('"$BRANCHES"' < 70) exit 1; }'
      - name: Generate coverage badge
        run: npm run coverage:badge
      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.node }}
          path: |
            coverage
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-and-test-artifacts-${{ matrix.node }}
          path: |
            migration-run.json
            test-output.txt
            junit-report.xml
            coverage-badge.svg

  security:
    name: security & lint
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-node-20-${{ hashFiles('**/package-lock.json','**/pnpm-lock.yaml','**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: ESLint
        run: |
          if [ -f .eslintrc.js ] || [ -f .eslintrc.cjs ] || [ -f .eslintrc.json ]; then npx eslint . || exit 1; else echo 'No ESLint config found'; fi
      - name: npm audit
        run: npm audit --omit=dev || echo 'Audit completed with advisories'
      - name: Secret scan (gitleaks)
        uses: gitleaks/gitleaks-action@v2
        with:
          args: --no-git -v
        continue-on-error: false
      - name: SAST (Semgrep)
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/ci
          output: semgrep.sarif
          format: sarif
        continue-on-error: false
      - name: Upload Semgrep SARIF
        uses: actions/upload-sarif@v2
        with:
          sarif_file: semgrep.sarif
      - name: Pending migrations (info)
        run: npm run db:migrate:pending:json || true

  summary:
    name: pipeline summary
    runs-on: ubuntu-latest
    needs: [build-and-test, security, endpoint-probes]
    steps:
      - name: Done
        run: echo "CI pipeline complete"
      - name: Slack notification
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then echo "Slack webhook not configured"; exit 0; fi
          B_RES='${{ needs.build-and-test.result }}'
          S_RES='${{ needs.security.result }}'
          P_RES='${{ needs.endpoint-probes.result }}'
          P_OK='${{ needs.endpoint-probes.outputs.probe_overall_ok }}'
          COLOR="#2EB67D"
          if [ "$B_RES" != "success" ] || [ "$S_RES" != "success" ] || [ "$P_RES" != "success" ]; then COLOR="#E01E5A"; fi
          TEXT="SentinelScope CI: build=$B_RES security=$S_RES probes=$P_RES (endpoints_ok=$P_OK)"
          curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"$TEXT\"}" "$SLACK_WEBHOOK_URL"

  container-scan:
    name: container security (Trivy)
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build image
        run: docker build -t sentinelscope:ci . || echo "No Dockerfile present; skipping build" && exit 0
      - name: Trivy scan (image)
        if: success()
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: sentinelscope:ci
          format: table
          vuln-type: 'os,library'
          ignore-unfixed: true
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
      - name: Trivy filesystem SARIF
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          path: .
          scanners: 'vuln,secret,config,license'
          format: sarif
          output: trivy-fs.sarif
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
      - name: Upload Trivy FS SARIF
        uses: actions/upload-sarif@v2
        with:
          sarif_file: trivy-fs.sarif
      - name: Trivy SARIF
        if: success()
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: sentinelscope:ci
          format: sarif
          output: trivy-results.sarif
          vuln-type: 'os,library'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
      - name: Upload Trivy SARIF
        if: success()
        uses: actions/upload-sarif@v2
        with:
          sarif_file: trivy-results.sarif

  endpoint-probes:
    name: endpoint probes
    runs-on: ubuntu-latest
    needs: build-and-test
    outputs:
      probe_overall_ok: ${{ steps.probe.outputs.overall_ok }}
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres" --health-interval=5s --health-timeout=5s --health-retries=10
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/testdb
      ALLOW_LEGACY_X_USER_ID: true
      SKIP_SCHEMA_CHECKS: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Apply migrations
        run: npm run db:migrate
      - name: Build (server + client)
        run: npm run build
      - name: Start server
        run: |
          node dist/index.js &
          echo $! > server.pid
      - name: Wait for /health
        run: |
          ATTEMPTS=40
          until curl -sf http://localhost:3001/health >/dev/null 2>&1; do
            ATTEMPTS=$((ATTEMPTS-1))
            if [ "$ATTEMPTS" -le 0 ]; then echo "Server failed to become healthy"; exit 1; fi
            sleep 1
          done
      - name: Probe endpoints (MFA & WebAuthn)
        id: probe
        run: |
          npm run probe:endpoints -- --user ci-probe --email ci-probe@example.com --base http://localhost:3001 --json-only --output endpoint-probes.json
          OVERALL=$(node -e "const d=require('./endpoint-probes.json');process.stdout.write(d.overallOk?'true':'false')")
          echo "overall_ok=$OVERALL" >> $GITHUB_OUTPUT
      - name: Upload probe artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: endpoint-probes
          path: endpoint-probes.json
      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then kill $(cat server.pid) || true; fi
